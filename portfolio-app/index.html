<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My First dApp</title>

    <style>
      body {
        text-align: center;
        font-family: Arial, Helvetica, sans-serif;
      }

      /* div {
        width: 50%;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
      } */

      button {
        width: 50%;
        margin: 10px 0px 5px 0px;
      }
    </style>
  </head>

  <body>
    <div id="account">
      <h1>My Portfolio dApp!</h1>

      <button onclick="connectToWallet()">Connect to Waller</button>
      <button onclick="disconnectFromWallet()">Disconnect from Waller</button>

      <hr />

      <label for="wallet_address_lb">Wallet Addres: </label>
      <label id="wallet_address_lb">Disconnected</label>
    </div>
    <hr />
    <div id="editPortfolio">
      <label for="assetName">Asset Symbol:</label>
      <input type="text" id="asset_name" /> <br />
      <button onclick="addAsset()">Add Asset</button>
    </div>
    <hr />
    <div id="portfolio">
      <button onclick="getPortfolio()">Get Portfolio</button>
    </div>
  </body>
  <!--Add ether.js-->
  <script
    src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
    type="application/javascript"
  ></script>

  <script>
    const XRP_EVM_DEV_URL = "https://rpc-evm-sidechain.xrpl.org";
    const contractAddress = "0x29BBF5f4f19F7F782a26b51Ae22573B29a9e8C4e";
    const CONTRACT_ABI = [
      {
        inputs: [],
        stateMutability: "nonpayable",
        type: "constructor",
      },
      {
        anonymous: false,
        inputs: [
          {
            indexed: true,
            internalType: "string",
            name: "symbol",
            type: "string",
          },
          {
            indexed: true,
            internalType: "string",
            name: "action",
            type: "string",
          },
          {
            indexed: false,
            internalType: "int256",
            name: "amount",
            type: "int256",
          },
          {
            indexed: false,
            internalType: "uint256",
            name: "timestamp",
            type: "uint256",
          },
        ],
        name: "AssetOperation",
        type: "event",
      },
      {
        inputs: [
          {
            internalType: "string",
            name: "symbol",
            type: "string",
          },
        ],
        name: "addAsset",
        outputs: [],
        stateMutability: "nonpayable",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "",
            type: "address",
          },
          {
            internalType: "uint256",
            name: "",
            type: "uint256",
          },
        ],
        name: "assets",
        outputs: [
          {
            internalType: "bytes8",
            name: "symbol",
            type: "bytes8",
          },
          {
            internalType: "int256",
            name: "size",
            type: "int256",
          },
        ],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "bytes8",
            name: "_bytes",
            type: "bytes8",
          },
        ],
        name: "bytesToString",
        outputs: [
          {
            internalType: "string",
            name: "",
            type: "string",
          },
        ],
        stateMutability: "pure",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "string",
            name: "symbol",
            type: "string",
          },
        ],
        name: "findAsset",
        outputs: [
          {
            components: [
              {
                internalType: "bytes8",
                name: "symbol",
                type: "bytes8",
              },
              {
                internalType: "int256",
                name: "size",
                type: "int256",
              },
            ],
            internalType: "struct Portfolio.Asset",
            name: "",
            type: "tuple",
          },
        ],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [],
        name: "getPortfolio",
        outputs: [
          {
            components: [
              {
                internalType: "bytes8",
                name: "symbol",
                type: "bytes8",
              },
              {
                internalType: "int256",
                name: "size",
                type: "int256",
              },
            ],
            internalType: "struct Portfolio.Asset[]",
            name: "",
            type: "tuple[]",
          },
        ],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "string",
            name: "symbol",
            type: "string",
          },
        ],
        name: "hasAsset",
        outputs: [
          {
            internalType: "bool",
            name: "",
            type: "bool",
          },
        ],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [],
        name: "owner",
        outputs: [
          {
            internalType: "address",
            name: "",
            type: "address",
          },
        ],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "string",
            name: "symbol",
            type: "string",
          },
        ],
        name: "removeAsset",
        outputs: [],
        stateMutability: "nonpayable",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "string",
            name: "_str",
            type: "string",
          },
        ],
        name: "stringToBytes",
        outputs: [
          {
            internalType: "bytes8",
            name: "",
            type: "bytes8",
          },
        ],
        stateMutability: "pure",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "string",
            name: "symbol",
            type: "string",
          },
          {
            internalType: "int256",
            name: "size",
            type: "int256",
          },
        ],
        name: "updateAsset",
        outputs: [],
        stateMutability: "nonpayable",
        type: "function",
      },
    ];

    let provider = null;
    let signer = null;
    let walletAddress = null;

    async function connectToWallet() {
      // A Web3Provider wraps a standard Web3 provider, which is
      // what MetaMask injects as window.ethereum into each page
      provider = new ethers.providers.Web3Provider(window.ethereum);
      console.log(provider);

      // MetaMask requires requesting permission to connect users accounts
      if (walletAddress == null) {
        // Runs only they are brand new, or have hit the disconnect button
        await window.ethereum.request({
          method: "wallet_requestPermissions",
          params: [
            {
              eth_accounts: {},
            },
          ],
        });
      }

      walletAddress = await window.ethereum.request({
        method: "eth_requestAccounts",
        params: [
          {
            eth_accounts: {},
          },
        ],
      });

      console.log(walletAddress);
      document.getElementById("wallet_address_lb").innerHTML = walletAddress;

      // The MetaMask plugin also allows signing transactions to
      // send ether and pay to change state within the blockchain.
      // For this, you need the account signer...
      const signer = provider.getSigner();
      console.log(signer);

      // TODO: ADD CHAIN ID VALIDATION
    }

    async function disconnectFromWallet() {
      provider = null;
      signer = null;
      walletAddress = null;

      document.getElementById("wallet_address_lb").innerHTML = "Disconnected";
    }
  </script>
</html>
